<!--
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<div class="interpreterHead">
    <div class="header">
        <div class="row">
            <div class="col-md-12">
                <h3 class="new_h3"> 后台插件管理 </h3>
                <div class="pull-right" style="margin-top:10px">
                    <button class="btn btn-default btn-sm" ng-click="showRepositoryInfo = !showRepositoryInfo">
                        <i class="fa fa-database" ng-style="{color: showRepositoryInfo ? '#3071A9' : 'black' }"></i> 插件库 </button>
                    <button class="btn btn-default btn-sm" ng-click="showAddNewSetting = !showAddNewSetting">
                        <i class="fa fa-plus"></i> 创建 </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12"> 系统支持插件方式对接各种后台（JDBC数据库/Hive/Hbase/Spark/Python/R/Angular等），在这里可以对支持的插件进行增/删/查/改操作，也可以对插件和工作区进行绑定/解除绑定。 </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="input-group" style="margin-top: 10px">
                    <input type="text" ng-model="searchInterpreter" class="form-control ng-pristine ng-untouched ng-valid ng-empty"
                        ng-model-options="{ updateOn: 'default blur', debounce: { 'default': 300, 'blur': 0 } }" placeholder="Search interpreters">
                    <span class="input-group-btn">
                        <button type="submit" class="btn btn-default" ng-disabled="!navbar.connected">
                            <i class="glyphicon glyphicon-search"></i>
                        </button>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="row" ng-if="showRepositoryInfo">
        <div class="col-md-12">
            <hr>
            <h4>插件库</h4>
            <p>可用插件库列表，使用这些插件库无需手动解决插件的外部依赖问题。</p>
            <ul class="noDot">
                <li class="liVertical" ng-repeat="repo in repositories">
                    <a tabindex="0" class="btn btn-info" role="button" popover-trigger="focus" popover-placement="right" popover-html-unsafe="<label>URL: </label>
               {{repo.url}}<br>
               <label>Username: </label>
               {{repo.authentication.username}}<br>
               <label>Proxy host: </label>
               {{repo.proxy.host}}">
                        <span class="fa fa-database"></span> {{repo.id}}&nbsp;
                        <span ng-if="!isDefaultRepository(repo.id)" class="fa fa-close blackOpc"
                            ng-click="removeRepository(repo.id)"></span>
                    </a>
                </li>
                <li class="liVertical">
                    <div ng-include src="'components/repository-create/repository-dialog.html?v=1496974691584'"></div>
                    <div class="btn btn-default" data-toggle="modal" data-target="#repoModal">
                        <span class="fa fa-plus"></span>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div ng-include src="'app/interpreter/interpreter-create/interpreter-create.html?v=1496974691584'"></div>
</div>
<div class="box width-full" ng-repeat="setting in interpreterSettings | orderBy: 'name' | filter: {name:searchInterpreter} "
    interpreter-directive>
    <div id="{{setting.name | lowercase}}">
        <div class="row interpreter">
            <div class="col-md-12">
                <h3 class="interpreter-title">{{setting.name}}
                    <small>
                        <span style="display:inline-block" ng-repeat="interpreter in setting.interpreterGroup" title="{{interpreter.class}}">
                            <span ng-show="!$first">, </span> %
                            <span ng-show="!$parent.$first || $first">{{setting.name}}</span>
                            <span ng-show="(!$parent.$first || $first) && !$first">.</span>
                            <span ng-show="!$first">{{interpreter.name}}</span>
                        </span>
                    </small>
                    <small ng-switch="setting.status">
                        <small ng-switch-when="READY">
                            <i style="color: green; margin-right: 3px" class="fa fa-circle" uib-tooltip="Ready"> </i>
                        </small>
                        <small ng-switch-when="ERROR">
                            <i style="color: red; cursor: pointer" class="fa fa-circle" ng-click="showErrorMessage(setting)"
                                uib-tooltip="Error downloading dependencies"> </i>
                        </small>
                        <small ng-switch-default>
                            <i style="color: blue" class="fa fa-spinner spinAnimation" uib-tooltip="Dependencies are downloading">
                            </i>
                        </small>
                    </small>
                </h3>
                <span style="float:right" ng-show="!valueform.$visible">
                    <button class="btn btn-default btn-xs" ng-click="showSparkUI(setting.id)" ng-show="setting.group == 'spark'">
                        <span class="fa fa-external-link"></span> spark ui</button>
                    <button class="btn btn-default btn-xs" ng-click="valueform.$show();
                  copyOriginInterpreterSettingProperties(setting.id)">
                        <span class="fa fa-pencil"></span> 编辑</button>
                    <button class="btn btn-default btn-xs" ng-click="restartInterpreterSetting(setting.id)">
                        <span class="fa fa-refresh"></span> 重启</button>
                    <button class="btn btn-default btn-xs" ng-click="removeInterpreterSetting(setting.id)">
                        <span class="fa fa-trash"></span> 删除</button>
                </span>
            </div>
        </div>
        <div class="row interpreter">
            <div class="col-md-12">
                <h5>选项</h5>
                <div class="row interpreter" style="margin-top: 5px">
                    <div class="col-md-6"> 插件稍后将会被安装
                        <span class="btn-group">
                            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" ng-disabled="!valueform.$visible">
                            {{getInterpreterRunningOption(setting.id)}}
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <li>
                                    <a style="cursor:pointer" ng-click="setInterpreterRunningOption(setting.id, 'shared', 'shared')">
                                    全局设置 </a>
                                </li>
                                <li>
                                    <a style="cursor:pointer" ng-click="setInterpreterRunningOption(setting.id, 'scoped', '')">
                                    按工作区设置 </a>
                                </li>
                                <li ng-if="ticket.principal !== 'anonymous'">
                                    <a style="cursor:pointer" ng-click="setInterpreterRunningOption(setting.id, 'shared', 'scoped')">
                                    按用户设置 </a>
                                </li>
                            </ul>
                        </span> in
                        <span class="btn-group">
                            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" ng-disabled="!valueform.$visible
                                   || getInterpreterRunningOption(setting.id) === 'Globally'">
                                <span ng-if="getInterpreterRunningOption(setting.id) !== 'Per User'"> {{getPerNoteOption(setting.id)}} </span>
                                <span ng-if="getInterpreterRunningOption(setting.id) === 'Per User'">
                                {{getPerUserOption(setting.id)}} </span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <li ng-if="getInterpreterRunningOption(setting.id) === 'Globally'">
                                    <a style="cursor:pointer" uib-tooltip="单个插件实例将对所有工作区共享" ng-click="setPerNoteOption(setting.id, 'shared')">
                                    按工作区共享 </a>
                                </li>
                                <li>
                                    <a style="cursor:pointer" ng-if="getInterpreterRunningOption(setting.id) === 'Per Note'"
                                        uib-tooltip="插件实例访问将以工作区为单位进行隔离" ng-click="setPerNoteOption(setting.id, 'scoped')"> 工作区可见 </a>
                                </li>
                                <li>
                                    <a style="cursor:pointer" ng-if="getInterpreterRunningOption(setting.id) === 'Per User'"
                                        uib-tooltip="插件实例访问将以用户为单位进行隔离" ng-click="setPerUserOption(setting.id, 'scoped')"> 用户可见 </a>
                                </li>
                                <li>
                                    <a style="cursor:pointer" ng-if="getInterpreterRunningOption(setting.id) === 'Per Note'"
                                        uib-tooltip="插件进程将以工作区为单位进行隔离" ng-click="setPerNoteOption(setting.id, 'isolated')"> 按工作区隔离 </a>
                                </li>
                                <li>
                                    <a style="cursor:pointer" ng-if="getInterpreterRunningOption(setting.id) === 'Per User'"
                                        uib-tooltip="插件进程将以工作区为单位进行隔离" ng-click="setPerUserOption(setting.id, 'isolated')"> 按用户隔离 </a>
                                </li>
                            </ul>
                        </span> 进程。
                        <span ng-if="getInterpreterRunningOption(setting.id) === 'Per User' && ticket.principal !== 'anonymous'">
                            <span ng-if="getPerNoteOption(setting.id) === 'shared'">
                                <button type="button" class="btn btn-default btn-xs" ng-click="setPerNoteOption(setting.id, 'scoped')"
                                    ng-disabled="!valueform.$visible" data-toggle="dropdown">
                                    <i class="fa fa-plus"></i>
                                </button>
                            </span>
                        </span>
                    </div>
                    <div class="col-md-6"> &nbsp; </div>
                </div>
                <div class="row interpreter" style="margin-top: 6px" ng-if="getInterpreterRunningOption(setting.id) === 'Per User'
                    && ticket.principal !== 'anonymous'
                    && getPerNoteOption(setting.id) !== 'shared'">
                    <div class="col-md-12">
                        <span>
                            <span class="hidden-xs" style="padding-left: 190px">And </span>
                            <span class="visible-xs" style="padding-left: 0px">And </span>
                            <span class="btn-group">
                                <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" ng-disabled="true">
                                    <span> Per Note </span>
                                    <span class="caret"></span>
                                </button>
                            </span> in
                            <span class="btn-group">
                                <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" ng-disabled="!valueform.$visible">
                                    <span> {{getPerNoteOption(setting.id)}} </span>
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" role="menu">
                                    <li>
                                        <a style="cursor:pointer" uib-tooltip="插件实例访问将以工作区为单位进行隔离" ng-click="setPerNoteOption(setting.id, 'scoped')">
                                        工作区可见 </a>
                                    </li>
                                    <li>
                                        <a style="cursor:pointer" uib-tooltip="插件进程将以工作区为单位进行隔离" ng-click="setPerNoteOption(setting.id, 'isolated')">
                                        按工作区隔离 </a>
                                    </li>
                                </ul>
                            </span> 进程。
                            <button type="button" class="btn btn-default btn-xs" ng-disabled="!valueform.$visible" ng-click="setPerNoteOption(setting.id, 'shared')"
                                data-toggle="dropdown">
                                <i class="fa fa-minus"></i>
                            </button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row interpreter" style="margin-top: 5px" ng-show="getInterpreterRunningOption(setting.id)=='Per User' && getPerUserOption(setting.id)=='isolated'">
            <div class="col-md-12">
                <div class="checkbox remove-margin-top-bottom">
                    <span class="input-group" style="line-height:30px">
                        <label>
                            <input type="checkbox" style="width:20px" ng-model="setting.option.isUserImpersonate" ng-disabled="!valueform.$visible"> 用户模拟 </label>
                    </span>
                </div>
            </div>
        </div>
        <div class="row interpreter">
            <div class="col-md-12">
                <div class="checkbox remove-margin-top-bottom">
                    <span class="input-group" style="line-height:30px">
                        <label>
                            <input type="checkbox" style="width:20px" id="isExistingProcess" ng-model="setting.option.isExistingProcess"
                                ng-disabled="!valueform.$visible"> 连接到已存在的进程 </label>
                    </span>
                </div>
            </div>
        </div>
        <div class="row interpreter" ng-if="setting.option.isExistingProcess">
            <div class="col-md-12">
                <b>主机</b>
                <input id="newInterpreterSettingHost" input pu-elastic-input pu-elastic-input-minwidth="180px" ng-model="setting.option.host"
                    ng-disabled="!valueform.$visible"> </div>
            <div class="col-md-12">
                <b>端口</b>
                <input id="newInterpreterSettingPort" input pu-elastic-input pu-elastic-input-minwidth="180px" ng-model="setting.option.port"
                    ng-disabled="!valueform.$visible"> </div>
        </div>
        <div class="row interpreter">
            <div class="col-md-12">
                <div class="checkbox remove-margin-top-bottom">
                    <span class="input-group" style="line-height:30px">
                        <label>
                            <input type="checkbox" style="width:20px !important" id="idShowPermission" ng-click="togglePermissions(setting.name)"
                                ng-model="setting.option.setPermission" ng-disabled="!valueform.$visible"> 设置权限 </label>
                    </span>
                </div>
            </div>
        </div>
        <div class="row interpreter">
            <div class="col-md-12">
                <!-- permissions -->
                <div ng-show="setting.option.setPermission" class="permissionsForm">
                    <div>
                        <p> 输入逗号对多个用户进行分隔。Enter comma separated users in the fields.
                            <br> “*”号表示任何用户都可以运行该插件。 </p>
                        <div>
                            <span class="owners">所有者 </span>
                            <select id="{{setting.name}}Users" class="form-control" multiple ng-disabled="!valueform.$visible">
                                <option ng-repeat="user in setting.option.users" selected>{{user}} </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row interpreter" style="margin-top:20px !important">
            <div ng-show="_.isEmpty(setting.properties) && _.isEmpty(setting.dependencies) && !valueform.$visible" class="col-md-12 gray40-message">
                <em>插件当前没有任何属性设置和依赖设置。</em>
            </div>
            <div class="col-md-12" ng-show="!_.isEmpty(setting.properties) || valueform.$visible">
                <h5>属性</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th style="width:40%">键
                                <th style="width:40%">值
                                    <th style="width:20%" ng-if="valueform.$visible">动作
                                        <tr ng-repeat="key in setting.properties | sortByKey">
                                            <td style="vertical-align: middle">{{key}}
                                                <td style="vertical-align: middle">
                                                    <span editable-textarea="setting.properties[key]" e-form="valueform" e-msd-elastic>
                                                    {{setting.properties[key] | breakFilter}} </span>
                                                    <td style="vertical-align: middle"
                                                        ng-if="valueform.$visible">
                                                        <button class="btn btn-default btn-sm fa fa-remove" ng-click="removeInterpreterProperty(key, setting.id)">
                                                        </button>
                                                        <tr ng-if="valueform.$visible">
                                                            <td style="vertical-align: middle">
                                                                <input ng-model="setting.propertyKey" pu-elastic-input pu-elastic-input-minwidth="180px">
                                                                <td style="vertical-align: middle">
                                                                    <textarea msd-elastic ng-model="setting.propertyValue"></textarea>
                                                                    <td style="vertical-align: middle">
                                                                        <button class="btn btn-default btn-sm fa fa-plus" ng-click="addNewInterpreterProperty(setting.id)">
                                                                        </button>
                </table>
            </div>
        </div>
        <div class="row interpreter">
            <div class="col-md-12" ng-show="!_.isEmpty(setting.dependencies) || valueform.$visible">
                <h5>依赖</h5>
                <p class="gray40-message" style="font-size:12px" ng-show="valueform.$visible"> 插件启动时这些依赖包将会被添加到环境变量中。</p>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th style="width:40%">artifact
                                <th style="width:40%">exclude
                                    <th style="width:20%" ng-if="valueform.$visible">action
                                        <tr ng-repeat="dep in setting.dependencies">
                                            <td>
                                                <span editable-text="dep.groupArtifactVersion" e-placeholder="groupId:artifactId:version or local file path"
                                                    e-form="valueform" e-msd-elastic e-style="width:100%"> {{dep.groupArtifactVersion | breakFilter}} </span>
                                                <td>
                                                    <textarea ng-if="valueform.$visible" ng-model="dep.exclusions" placeholder="(Optional) comma separated groupId:artifactId list"
                                                        form="valueform" e-msd-elastic ng-list="">
                                                    </textarea>
                                                    <div ng-if="!valueform.$visible">{{dep.exclusions.join()}}</div>
                                                    <td ng-if="valueform.$visible">
                                                        <button class="btn btn-default btn-sm fa fa-remove" ng-click="removeInterpreterDependency(dep.groupArtifactVersion, setting.id)">
                                                        </button>
                                                        <tr ng-if="valueform.$visible">
                                                            <td>
                                                                <input ng-model="setting.depArtifact" placeholder="groupId:artifactId:version or local file path"
                                                                    style="width: 100%">
                                                                <td>
                                                                    <textarea ng-model="setting.depExclude" placeholder="(Optional) comma separated groupId:artifactId list"
                                                                        msd-elastic ng-list="">
                                                                    </textarea>
                                                                    <td>
                                                                        <button class="btn btn-default btn-sm fa fa-plus" ng-click="addNewInterpreterDependency(setting.id)">
                                                                        </button>
                </table>
                <form editable-form name="valueform" onaftersave="updateInterpreterSetting(valueform, setting.id)" ng-show="valueform.$visible">
                    <button type="submit" class="btn btn-primary"> Save </button>
                    <button type="button" class="btn btn-default" ng-disabled="valueform.$waiting" ng-click="valueform.$cancel(); resetInterpreterSetting(setting.id)">
                    取消 </button>
                </form>
            </div>
        </div>
    </div>
</div>